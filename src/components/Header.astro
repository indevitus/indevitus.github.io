---
import ThemeSwitcher from './ThemeSwitcher.astro';
---

<header class="absolute left-0 top-0 w-full bg-white dark:bg-black z-50 font-display transition-all duration-300">
  <div
    id="header-content"
    class="container flex justify-between items-center lg:justify-start select-none py-6 bg-white dark:bg-black transition-all duration-300"
  >
    <a href="/" title="Indevitus" class="flex items-center gap-3">
      <img
        id="company-logo"
        src="/badge-white.svg"
        alt="Indevitus"
        height="80px"
        class="h-12 lg:h-16 mix-blend-difference transition-height duration-300"
      />
    </a>

    <button
      id="hamburger"
      class="no-tap-highlight cursor-pointer bg-transparent lg:hidden"
      aria-controls="menu"
    >
      <span class="line" />
      <span class="line" />
      <span class="line" />
    </button>

    <nav
      id="menu"
      class="flex flex-col overflow-y-auto fixed w-full h-[100dvh] lg:h-auto bottom-0 left-0 pt-8 pb-24 bg-white dark:bg-black transition-colors duration-300 z-50 invisible lg:static lg:flex-row lg:visible lg:p-0 lg:w-auto lg:ml-auto lg:overflow-visible uppercase"
    >
      <ul class="container flex flex-col lg:flex-row lg:space-x-8 lg:items-center lg:px-0 text-black dark:text-white text-sm">
        <li class="mb-6 lg:mb-0">
          <a
            href="#clients"
            class="relative pb-1 after:content-[''] after:absolute after:bottom-0 after:h-[1px] after:transition-[width] after:duration-300 after:ease-in-out after:left-0 after:w-0 after:bg-black dark:after:bg-white hover:after:w-full"
            >Clients</a>
        </li>
        <li class="mb-6 lg:mb-0">
          <a
            href="#contact"
            class="relative pb-1 after:content-[''] after:absolute after:bottom-0 after:h-[1px] after:transition-[width] after:duration-300 after:ease-in-out after:left-0 after:w-0 after:bg-black dark:after:bg-white hover:after:w-full"
            >Contact</a>
        </li>
      </ul>

      <div class="container lg:px-0 lg:ml-8 mt-auto py-2 lg:py-0">
        <ThemeSwitcher />
      </div>
    </nav>
  </div>
</header>


<script>
  const BREAKPOINT_LG = 1024;
  const FOOTER_COLLISION_OFFSET = 10;
  const header = document.querySelector('header');
  const hamburger = document.getElementById('hamburger');
  const menu = document.getElementById('menu');
  const headerContent = document.getElementById('header-content');
  const companyLogo = document.getElementById('company-logo');

  let mobileMenuOpen = false;
  let lastScrollTop = 0;

  function bodyScrollLock () {
    document.body.style.overflowY = mobileMenuOpen ? 'hidden' : 'auto';
  }

  function mobileMenuToggle () {
    mobileMenuOpen = !mobileMenuOpen;
    const visibilityClass = mobileMenuOpen ? 'visible' : 'invisible';

    if (menu) {
      menu?.classList.replace(visibilityClass === 'visible' ? 'invisible' : 'visible', visibilityClass);
      menu.style.top = `${header?.offsetHeight}px`;
      hamburger?.classList.toggle('is-opened', mobileMenuOpen);
      bodyScrollLock();
    }
  }

  function onResize() {
    if (window.innerWidth > BREAKPOINT_LG) {
      menu?.classList.replace('visible', 'invisible');
      hamburger?.classList.remove('is-opened');
      mobileMenuOpen = false;
      bodyScrollLock();
    }
  }

  function animateSlideUpHeader() {
    header?.classList.remove('animate-slide-down');
    header?.classList.add('animate-slide-up');

    setTimeout(() => {
      headerContent?.classList.remove('border-b', 'border-black', 'dark:border-neutral-100', '!py-2');
      companyLogo?.classList.remove('lg:!h-12', '!h-10');
    }, 500)
  }

  function animateSlideDownHeader() {
    header?.classList.add('!fixed');
    header?.classList.remove('animate-slide-up');
    header?.classList.add('animate-slide-down');
    headerContent?.classList.add('border-b', 'border-black', 'dark:border-neutral-100', '!py-2');
    companyLogo?.classList.add('lg:!h-12', '!h-10');
  }

  function animateFromFooterCollision(isFooterObserved: boolean) {
    if (isFooterObserved) {
      header?.classList.remove('animate-slide-down');
      header?.classList.add('animate-slide-up');
    } else {
      header?.classList.remove('animate-slide-up');
      header?.classList.add('animate-slide-down');
    }
  }

  function headerStickyToggle () {
    const hero = document.getElementById('hero');
    const footerRect = document.querySelector('footer')?.getBoundingClientRect();

    if (header && footerRect && companyLogo && hero) {
      const isFooterObserved = footerRect.top <= header?.offsetHeight - FOOTER_COLLISION_OFFSET
      const heroOffset = (hero?.offsetHeight - 112) + 40;
      const isSticky = window.scrollY >= heroOffset;
      const isHeaderInitialPosition = window.scrollY < 220;
      const st = document.documentElement.scrollTop;

      if (isHeaderInitialPosition) {
        header.classList.remove('!fixed');
        header.classList.remove('animate-slide-up');
      }

      if (st < lastScrollTop) {
        if (st < heroOffset && !isHeaderInitialPosition) {
          animateSlideUpHeader();
        }
      } else {
        if (isSticky) {
          animateSlideDownHeader();
        }
      }

      lastScrollTop = st <= 0 ? 0 : st;

      if (isSticky) {
        animateFromFooterCollision(isFooterObserved);
      }
    }
  }

  window.onresize = onResize;
  window.onscroll = headerStickyToggle;
  window.onload = headerStickyToggle;

  if (hamburger) {
    hamburger.addEventListener("click", mobileMenuToggle);
  }
</script>

<style>
  .line {
    @apply block my-[6px] h-[2px] w-[22px] origin-center transform-gpu rounded-none bg-black dark:bg-white transition-all duration-300 ease-in-out;
  }

  .is-opened .line:nth-child(1) {
    @apply translate-y-2 rotate-45;
  }

  .is-opened .line:nth-child(2) {
    @apply opacity-0;
  }

  .is-opened .line:nth-child(3) {
    @apply -translate-y-2 -rotate-45;
  }
</style>
